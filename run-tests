#!/bin/bash

# fail on error
set -e
MVN="${PWD}/mvnw"

if [[ ! $TRAVIS ]]; then
  # clean existing artefacts
  # note that mvn clean could fail if POM are incorrect
  find . -name target -type d -exec rm -r "{}" \; || true

  echo "[INFO] Applying steps executed by Travis"
  echo "[INFO] See https://docs.travis-ci.com/user/languages/java/#Projects-Using-Maven"
  sleep 2

  # Travis installs dependencies
  "$MVN" install -DskipTests=true -Dmaven.javadoc.skip=true -B -V
fi

# Install jflex in local repo
# implies: validate, compile, test, package, verify
"$MVN" install

# regression test suite must run in its own directory
cd testsuite/testcases && "$MVN" test
cd ../..

## run jflex examples
# Each line must end with the test command to make the script exit
# in case of error (see #242)
cd jflex/examples
cd simple-maven && "$MVN" test
cd ..
cd standalone-maven && "$MVN" test
cd ..
# don't assume byacc/j is installed, just run lexer
cd byaccj && make clean && make Yylex.java
cd ..
cd cup && make clean && make
cd ..
cd interpreter && make clean && make
cd ..
cd java && make clean && make
cd ..
cd zero-reader && make clean && make
cd ..
# leave jflex/examples
cd ../..

# also check ant build
cd jflex
ant gettools build test
cd ..
