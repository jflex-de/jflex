# We also compile on pull requests.
branches:
  only:
  - master
  - aggregated-java-sources
  - travis

# We don't use the git log, a very small depth is sufficient
git:
  depth: 3

language: java

jdk: openjdk9

# Empty the previously built artifacts
# They cannot be deleted in the before_cache phase,
# otherwise `mvn site` fails in the before_deploy phase.
before_install: ./scripts/clean.sh

install: ./mvnw -version

jobs:
  include:
    - stage: Check Java format
      script: echo "TODO"
      jdk: openjdk9
    - stage: Compile and test
      script:
        - ./scripts/test-unit.sh
        - ./scripts/test-regression.sh
      jdk:
      - openjdk7
      - oraclejdk8
      - openjdk9
    - stage: Deploy site
      jdk: openjdk9
      if: branch = travis
      script: ./scripts/mvn-site.sh
      deploy: gh-pages
        provider: pages
        skip_cleanup: true
        local_dir: target/maven-staging-site/maven-site
        # GITHUB_TOKEN set in travis-ci.org dashboard
        github_token: $GITHUB_TOKEN
        repo: jflex-de/jflex-web
        name: Travis site-deploy bot
        keep-history: true
    - stage: Commit aggregated source
      jdk: openjdk9
      if: branch = travis
      script: ./scripts/mvn-aggregate-srcs.sh
      deploy:
        provider: script
        skip_cleanup: true
        script: ./scripts/deploy-source-code.sh
    - stage: cache

# Travis sometimes fails to download deps from repo1.maven.org
# A cache avoids downloading too much, and will also speed up the build.
# NB: There is one cache per branch and language version/ compiler version/ JDK version
cache:
  # The timeout (in seconds) empties the cache to avoid being stuck with a corrupted artefact
  timeout: 86400  # 24 hours
  directories:
  - $HOME/.m2
  - jflex/lib
